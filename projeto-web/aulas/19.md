### Aula 19: Flask: Integração com Bancos de Dados (SQLite)

#### Introdução

A integração de um aplicativo web com um banco de dados é essencial para armazenar e gerenciar dados de forma eficiente. O **SQLite** é um banco de dados leve, fácil de configurar, e perfeito para projetos pequenos e médios. Nesta aula, vamos aprender como integrar o Flask com o SQLite, utilizando boas práticas para gerenciar conexões com o banco de dados de forma segura e eficiente.

#### O que é SQLite?

O **SQLite** é um sistema de gerenciamento de banco de dados leve que armazena dados em um único arquivo no disco. Ele não requer a instalação de um servidor e é perfeito para aplicativos de pequeno porte ou em desenvolvimento.

#### Como Integrar Flask com SQLite

O Flask oferece suporte para integração com bancos de dados, e podemos usar a biblioteca **`sqlite3`** do Python para conectar e manipular dados no banco de dados. Vamos aprender como gerenciar conexões corretamente usando **Context Manager**, o que garante que as conexões sejam abertas e fechadas de forma adequada.

#### Estrutura Básica do Projeto Flask com SQLite

Aqui está a estrutura básica do nosso projeto Flask integrado com SQLite:

```
projeto_web19/
│
├── app/
│   ├── templates/
│   ├── __init__.py
│   ├── routes.py
│   └── models.py
│
├── meu_banco.db
├── run.py
└── venv/
```

1. **`app/models.py`**: Onde definimos a estrutura das tabelas e como os dados serão armazenados no banco.
2. **`meu_banco.db`**: Arquivo do banco de dados SQLite.
3. **`routes.py`**: Onde definimos as rotas e interagimos com o banco de dados.

#### Passo 1: Configurando o Banco de Dados SQLite

Primeiro, vamos configurar o Flask para usar o SQLite de forma eficiente, garantindo que as conexões sejam fechadas adequadamente.

##### No arquivo `app/__init__.py`:

Aqui, vamos configurar a aplicação Flask e criar uma função `conectar_bd()` para conectar ao banco de dados:

```python
from flask import Flask
from app import routes
import sqlite3

app = Flask(__name__)

def conectar_bd():
    return sqlite3.connect('meu_banco.db')

```

A função `conectar_bd()` estabelece uma conexão com o banco de dados. Vamos garantir que essa conexão seja gerenciada corretamente nas funções que interagem com o banco.

#### Passo 2: Criando e Inicializando o Banco de Dados

Precisamos criar uma tabela no banco de dados antes de podermos armazenar dados. Vamos criar um arquivo `models.py` para definir as tabelas.

##### No arquivo `app/models.py`:

Aqui, criaremos a tabela de usuários usando `VARCHAR` para as colunas `nome` e `email`.

```python
from app import conectar_bd

def criar_tabela():
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('''
            CREATE TABLE IF NOT EXISTS usuarios (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                nome VARCHAR(100) NOT NULL,  -- Limite de 100 caracteres para o nome
                email VARCHAR(100) NOT NULL  -- Limite de 100 caracteres para o email
            )
        ''')
        con.commit()  # Garante que as mudanças são salvas no banco de dados
```

Usamos **`VARCHAR(100)`** para limitar o número de caracteres nos campos `nome` e `email`, e **`with`** para garantir que a conexão seja fechada corretamente.

#### Passo 3: Criando Rotas para Inserir e Exibir Dados

Agora, vamos criar as rotas para adicionar novos usuários e listar os usuários existentes.

##### No arquivo `app/routes.py`:

Aqui, vamos garantir que todas as operações com o banco de dados sejam gerenciadas com segurança, usando **Context Manager** para abrir e fechar conexões automaticamente.

```python
from flask import render_template, request, redirect, url_for
from app import app, conectar_bd

# Rota para exibir os usuários
@app.route('/')
def listar_usuarios():
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('SELECT * FROM usuarios')
        usuarios = cur.fetchall()
    return render_template('usuarios.html', usuarios=usuarios)

# Rota para adicionar um novo usuário
@app.route('/adicionar', methods=['GET', 'POST'])
def adicionar_usuario():
    if request.method == 'POST':
        nome = request.form['nome']
        email = request.form['email']
        with conectar_bd() as con:
            cur = con.cursor()
            cur.execute('INSERT INTO usuarios (nome, email) VALUES (?, ?)', (nome, email))
            con.commit()  # Salva as alterações no banco de dados
        return redirect(url_for('listar_usuarios'))
    return render_template('adicionar.html')
```

- **`with conectar_bd() as con:`**: O uso do gerenciador de contexto `with` garante que a conexão seja fechada automaticamente após o uso.
- **`con.commit()`**: Após inserir novos dados, o método `commit()` é chamado para confirmar as alterações.

#### Passo 4: Criando Templates para Exibir e Adicionar Usuários

Agora vamos criar dois templates: um para listar os usuários e outro para adicionar novos.

##### No arquivo `app/templates/usuarios.html`:

Este template exibirá a lista de usuários cadastrados:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Usuários</title>
</head>
<body>
    <h1>Lista de Usuários</h1>
    <ul>
        {% for usuario in usuarios %}
            <li>{{ usuario[1] }} - {{ usuario[2] }}</li>
        {% endfor %}
    </ul>
    <a href="{{ url_for('adicionar_usuario') }}">Adicionar Novo Usuário</a>
</body>
</html>
```

##### No arquivo `app/templates/adicionar.html`:

Este template será usado para adicionar novos usuários:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Usuário</title>
</head>
<body>
    <h1>Adicionar Novo Usuário</h1>
    <form method="POST">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" name="nome" required>
        <br><br>
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
        <br><br>
        <button type="submit">Adicionar</button>
    </form>
    <a href="{{ url_for('listar_usuarios') }}">Voltar</a>
</body>
</html>
```

#### Passo 5: Executando a Aplicação

Agora vamos rodar a aplicação e testar a integração com o banco de dados.

1. **No arquivo `run.py`:**

```python
from app import app
from app.models import criar_tabela

if __name__ == "__main__":
    criar_tabela()  # Cria a tabela de usuários ao iniciar a aplicação
    app.run(debug=True)
```

2. **Rodar a aplicação:**

No terminal, execute o seguinte comando:

```sh
python run.py
```

- **Acesse `http://127.0.0.1:5000/`** para ver a lista de usuários.
- **Acesse `http://127.0.0.1:5000/adicionar`** para adicionar um novo usuário.

#### Conclusão

Nesta aula, aprendemos como integrar o Flask com o banco de dados SQLite de forma eficiente, utilizando o gerenciador de contexto para garantir que as conexões sejam abertas e fechadas corretamente. Também vimos como criar, ler e adicionar dados no banco de dados, usando boas práticas de desenvolvimento.

#### Exercícios Práticos

1. **Atualize Usuários**: Adicione uma rota que permita editar o nome e o email de um usuário existente.
2. **Exclua Usuários**: Adicione uma rota para excluir usuários do banco de dados.
3. **Validação de Formulários**: Adicione validação ao formulário para garantir que o email seja único e que o nome não esteja vazio.

Esses exercícios ajudarão você a praticar o uso de banco de dados com Flask e a desenvolver aplicações mais completas e robustas.