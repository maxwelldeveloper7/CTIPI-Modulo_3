### Aula 19: Flask: Integração com Bancos de Dados (SQLite)
![](./assets/19.jpeg)
#### Introdução

A integração de um aplicativo web com um banco de dados é essencial para armazenar e gerenciar dados de forma eficiente. O **SQLite** é um banco de dados leve, fácil de configurar, e perfeito para projetos pequenos e médios. Nesta aula, vamos aprender como integrar o Flask com o SQLite para criar, ler, atualizar e deletar dados de um banco de dados.

#### O que é SQLite?

O **SQLite** é um sistema de gerenciamento de banco de dados que armazena dados em um único arquivo no disco. Ele é simples de usar e não requer configuração de um servidor de banco de dados. Por isso, é uma ótima escolha para desenvolvimento de aplicativos pequenos ou para testar funcionalidades de banco de dados durante o desenvolvimento.

#### Como Integrar Flask com SQLite

O Flask oferece suporte à integração com bancos de dados, e podemos usar a biblioteca **`sqlite3`** do Python para conectar, consultar e manipular dados.

##### Estrutura Básica de um Projeto Flask com SQLite

Aqui está a estrutura básica do nosso projeto Flask que vai integrar o banco de dados SQLite:

```
meu_projeto/
│
├── app/
│   ├── templates/
│   ├── __init__.py
│   ├── routes.py
│   └── models.py
│
├── meu_banco.db
├── run.py
└── venv/
```

1. **`app/models.py`**: Onde definimos como os dados serão organizados e salvos no banco de dados.
2. **`meu_banco.db`**: O arquivo onde o SQLite vai armazenar os dados.
3. **`routes.py`**: Onde vamos criar as rotas para interagir com o banco de dados.

##### Passo 1: Configurando o Banco de Dados SQLite

Primeiro, vamos configurar o Flask para usar o SQLite. No arquivo `app/__init__.py`, crie a aplicação Flask e configure o caminho para o banco de dados:

```python
from flask import Flask
import sqlite3

app = Flask(__name__)

def conectar_bd():
    return sqlite3.connect('meu_banco.db')

from app import routes
```

Aqui, a função `conectar_bd()` será usada para conectar-se ao banco de dados `meu_banco.db`.

##### Passo 2: Criando e Inicializando o Banco de Dados

Antes de começar a armazenar dados, precisamos criar a tabela no banco de dados.

1. **No arquivo `app/models.py`, adicione o seguinte código para criar uma tabela de usuários:**

   ```python
   from app import conectar_bd

   def criar_tabela():
       con = conectar_bd()
       cur = con.cursor()
       cur.execute('''
           CREATE TABLE IF NOT EXISTS usuarios (
               id INTEGER PRIMARY KEY AUTOINCREMENT,
               nome TEXT NOT NULL,
               email TEXT NOT NULL
           )
       ''')
       con.commit()
       con.close()
   ```

   Este código cria uma tabela chamada `usuarios` com três colunas: `id`, `nome` e `email`.

2. **Agora, vamos modificar o arquivo `run.py` para inicializar o banco de dados quando a aplicação for executada:**

   ```python
   from app import app
   from app.models import criar_tabela

   if __name__ == "__main__":
       criar_tabela()  # Cria a tabela de usuários no banco de dados
       app.run(debug=True)
   ```

##### Passo 3: Criando Rotas para Inserir e Exibir Dados

Agora, vamos criar as rotas para adicionar novos usuários e listar os usuários existentes.

1. **No arquivo `app/routes.py`, adicione o código para as rotas:**

   ```python
   from flask import render_template, request, redirect, url_for
   from app import app, conectar_bd

   # Rota para exibir os usuários
   @app.route('/')
   def listar_usuarios():
       con = conectar_bd()
       cur = con.cursor()
       cur.execute('SELECT * FROM usuarios')
       usuarios = cur.fetchall()
       con.close()
       return render_template('usuarios.html', usuarios=usuarios)

   # Rota para adicionar um novo usuário
   @app.route('/adicionar', methods=['GET', 'POST'])
   def adicionar_usuario():
       if request.method == 'POST':
           nome = request.form['nome']
           email = request.form['email']
           con = conectar_bd()
           cur = con.cursor()
           cur.execute('INSERT INTO usuarios (nome, email) VALUES (?, ?)', (nome, email))
           con.commit()
           con.close()
           return redirect(url_for('listar_usuarios'))
       return render_template('adicionar.html')
   ```

   Aqui, criamos duas rotas:
   - **`/`**: Exibe a lista de usuários.
   - **`/adicionar`**: Permite adicionar novos usuários através de um formulário.

##### Passo 4: Criando Templates para Exibir e Adicionar Usuários

1. **No arquivo `app/templates/usuarios.html`, adicione o seguinte conteúdo para exibir a lista de usuários:**

   ```html
   <!DOCTYPE html>
   <html lang="pt-BR">
   <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>Lista de Usuários</title>
   </head>
   <body>
       <h1>Lista de Usuários</h1>
       <ul>
           {% for usuario in usuarios %}
               <li>{{ usuario[1] }} - {{ usuario[2] }}</li>
           {% endfor %}
       </ul>
       <a href="{{ url_for('adicionar_usuario') }}">Adicionar Novo Usuário</a>
   </body>
   </html>
   ```

2. **No arquivo `app/templates/adicionar.html`, adicione o formulário para adicionar um novo usuário:**

   ```html
   <!DOCTYPE html>
   <html lang="pt-BR">
   <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>Adicionar Usuário</title>
   </head>
   <body>
       <h1>Adicionar Novo Usuário</h1>
       <form method="POST">
           <label for="nome">Nome:</label>
           <input type="text" id="nome" name="nome" required>
           <br><br>
           <label for="email">Email:</label>
           <input type="email" id="email" name="email" required>
           <br><br>
           <button type="submit">Adicionar</button>
       </form>
       <a href="{{ url_for('listar_usuarios') }}">Voltar</a>
   </body>
   </html>
   ```

##### Passo 5: Executando a Aplicação

Agora, vamos executar a aplicação e testar a integração com o banco de dados:

1. **No terminal, execute o comando para rodar a aplicação:**
   ```sh
   python run.py
   ```

2. **Acesse `http://127.0.0.1:5000/` no navegador para ver a lista de usuários.**
3. **Acesse `http://127.0.0.1:5000/adicionar` para adicionar um novo usuário.**

#### Conclusão

Nesta aula, aprendemos a integrar o Flask com o banco de dados SQLite. Agora, você sabe como criar, ler e adicionar dados a partir do banco de dados em um aplicativo Flask. Essa é uma habilidade essencial para desenvolver aplicações web que precisam armazenar e gerenciar informações.

#### Exercícios Práticos

1. **Crie uma Rota para Atualizar Usuários**: Adicione uma nova rota que permita editar o nome e email de um usuário existente.
2. **Crie uma Rota para Deletar Usuários**: Adicione uma rota para excluir usuários do banco de dados.
3. **Adicione Validação de Formulários**: Modifique o formulário de adicionar usuário para garantir que o email seja único e que o nome não esteja em branco.

Esses exercícios ajudarão a reforçar seu entendimento sobre a integração de Flask com bancos de dados e a manipulação de dados usando o SQLite.