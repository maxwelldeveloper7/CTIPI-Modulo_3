### Aula 20: Exercícios Práticos de Flask (Rotas, Templates, Banco de Dados)
![](./assets/20.jpeg)
#### Introdução

Nesta aula, vamos aplicar conceitos de rotas, templates e banco de dados com **Flask**, conectando a um banco de dados PostgreSQL. O foco será na integração com o banco de dados sem ORM e na conversão correta de formatos de data, já que o PostgreSQL utiliza o formato `yyyy-mm-dd` enquanto os formulários HTML frequentemente utilizam `dd/mm/yyyy`.

#### Estrutura do Banco de Dados

As tabelas do banco de dados são:

1. **`escolas`**:
   - `codigo_censo` (VARCHAR): Código da escola (chave primária).
   - `nome_escola` (VARCHAR): Nome da escola.
   - `municipio` (VARCHAR): Município da escola.

2. **`familia`**:
   - `id_familia` (SERIAL): ID da família (chave primária).
   - `nome_mae` (VARCHAR): Nome da mãe.
   - `nome_pai` (VARCHAR): Nome do pai.

3. **`escola_alunos`**:
   - `id` (SERIAL): ID do aluno (chave primária).
   - `codigo_censo` (VARCHAR): Código da escola (chave estrangeira para a tabela `escolas`).
   - `etapa` (VARCHAR): Etapa de ensino.
   - `nome_completo` (VARCHAR): Nome completo do aluno.
   - `data_nascimento` (DATE): Data de nascimento do aluno.
   - `id_familia` (INT): ID da família (chave estrangeira para a tabela `familia`).

---

### Passo 1: Conectando-se ao Banco de Dados PostgreSQL

Para se conectar ao PostgreSQL, usaremos a biblioteca **`psycopg`**. Vamos garantir que a conexão seja configurada corretamente, seguindo o padrão DSN (Data Source Name).

##### 1.1. Instalando o `psycopg`:

No terminal, execute o seguinte comando para instalar o driver:

```bash
pip install psycopg
```

##### 1.2. Configurando a Conexão no `__init__.py`:

No arquivo `app/__init__.py`, configuramos a função de conexão ao banco de dados PostgreSQL usando uma string DSN:

```python
from flask import Flask
import psycopg

app = Flask(__name__)


def conectar_bd():
    # Usando a string de conexão (DSN)
    return psycopg.connect(
        "dbname=nome_do_banco user=seu_usuario password=sua_senha host=localhost"
    )
```

---

### Passo 2: Criando Rotas para Exibir e Inserir Dados

Vamos criar rotas para listar escolas, adicionar alunos e exibir as informações de alunos, além de garantir que as datas sejam formatadas corretamente para o banco de dados.

#### 2.1. Exibindo a Lista de Escolas

##### No arquivo `app/routes.py`, adicione a seguinte rota:

```python
from flask import render_template
from app import app, conectar_bd

@app.route('/escolas')
def listar_escolas():
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('SELECT * FROM escolas')
        escolas = cur.fetchall()
    return render_template('escolas.html', escolas=escolas)
```

##### Crie o template `escolas.html` para exibir os dados em uma tabela:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Escolas</title>
</head>
<body>
    <h1>Lista de Escolas</h1>
    <table border="1">
        <thead>
            <tr>
                <th>Código Censo</th>
                <th>Nome da Escola</th>
                <th>Município</th>
            </tr>
        </thead>
        <tbody>
            {% for escola in escolas %}
                <tr>
                    <td>{{ escola[0] }}</td>
                    <td>{{ escola[1] }}</td>
                    <td>{{ escola[2] }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
```

---

#### 2.2. Adicionando um Novo Aluno com Conversão de Data

Agora, vamos criar a rota para adicionar alunos ao banco, convertendo a data do formato `dd/mm/yyyy` para o formato aceito pelo PostgreSQL, `yyyy-mm-dd`.

##### No arquivo `app/routes.py`, adicione a rota para adicionar alunos:

```python
from flask import request, redirect, url_for, render_template
from app import app, conectar_bd
from datetime import datetime  # Import para conversão de datas

@app.route('/adicionar_aluno', methods=['GET', 'POST'])
def adicionar_aluno():
    if request.method == 'POST':
        nome_completo = request.form['nome_completo']
        data_nascimento = request.form['data_nascimento']
        codigo_censo = request.form['codigo_censo']
        etapa = request.form['etapa']
        id_familia = request.form['id_familia']
        
        # Converter a data de 'dd/mm/yyyy' para 'yyyy-mm-dd'
        data_nascimento_convertida = datetime.strptime(data_nascimento, '%d/%m/%Y').strftime('%Y-%m-%d')

        with conectar_bd() as con:
            cur = con.cursor()
            cur.execute('''
                INSERT INTO escola_alunos (codigo_censo, etapa, nome_completo, data_nascimento, id_familia)
                VALUES (%s, %s, %s, %s, %s)
            ''', (codigo_censo, etapa, nome_completo, data_nascimento_convertida, id_familia))
            con.commit()
        
        return redirect('/escolas')
    
    # Buscar escolas e famílias para preencher o formulário
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('SELECT codigo_censo, nome_escola FROM escolas')
        escolas = cur.fetchall()
        cur.execute('SELECT id_familia, nome_mae FROM familia')
        familias = cur.fetchall()
    
    return render_template('adicionar_aluno.html', escolas=escolas, familias=familias)
```

##### Crie o template `adicionar_aluno.html`:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Aluno</title>
</head>
<body>
    <h1>Adicionar Novo Aluno</h1>
    <form method="POST">
        <label for="nome_completo">Nome Completo:</label>
        <input type="text" id="nome_completo" name="nome_completo" required>
        <br><br>
        
        <label for="data_nascimento">Data de Nascimento:</label>
        <input type="text" id="data_nascimento" name="data_nascimento" placeholder="dd/mm/yyyy" required>
        <br><br>
        
        <label for="codigo_censo">Escola:</label>
        <select id="codigo_censo" name="codigo_censo">
            {% for escola in escolas %}
                <option value="{{ escola[0] }}">{{ escola[1] }}</option>
            {% endfor %}
        </select>
        <br><br>
        
        <label for="etapa">Etapa:</label>
        <input type="text" id="etapa" name="etapa" required>
        <br><br>
        
        <label for="id_familia">Família:</label>
        <select id="id_familia" name="id_familia">
            {% for familia in familias %}
                <option value="{{ familia[0] }}">{{ familia[1] }}</option>
            {% endfor %}
        </select>
        <br><br>
        
        <button type="submit">Adicionar Aluno</button>
    </form>
    <a href="/escolas">Voltar</a>
</body>
</html>
```

---

#### 2.3. Exibindo Informações de Alunos

##### No arquivo `app/routes.py`, adicione a rota para listar alunos:

```python
@app.route('/alunos')
def listar_alunos():
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('''
            SELECT escola_alunos.nome_completo, escola_alunos.data_nascimento, escolas.nome_escola, familia.nome_mae
            FROM escola_alunos
            JOIN escolas ON escola_alunos.codigo_censo = escolas.codigo_censo
            JOIN familia ON escola_alunos.id_familia = familia.id_familia
        ''')
        alunos = cur.fetchall()
    
    return render_template('alunos.html', alunos=alunos)
```

##### Crie o template `alunos.html`:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Alunos</title>
</head>
<body>
    <h1>Lista de Alunos</h1>
    <table border="1">
        <thead>
            <tr>
                <th>

Nome Completo</th>
                <th>Data de Nascimento</th>
                <th>Escola</th>
                <th>Nome da Mãe</th>
            </tr>
        </thead>
        <tbody>
            {% for aluno in alunos %}
                <tr>
                    <td>{{ aluno[0] }}</td>
                    <td>{{ aluno[1] }}</td>
                    <td>{{ aluno[2] }}</td>
                    <td>{{ aluno[3] }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="/escolas">Voltar</a>
</body>
</html>
```

---

### Conclusão

Nesta aula, aprendemos como trabalhar com rotas, templates e banco de dados PostgreSQL no Flask. Além disso, lidamos com a conversão correta de datas no formato `dd/mm/yyyy` para o formato aceito pelo PostgreSQL `yyyy-mm-dd`, garantindo que a aplicação funcione sem erros relacionados ao formato de data.

### Tarefas Extras:
1. **Adicionar Validação de Dados**: Implemente validações de entrada, como a verificação de duplicidade de nomes ou emails.
2. **Excluir Alunos**: Crie uma rota que permita excluir alunos da lista.
3. **Atualizar Alunos**: Implemente a funcionalidade de atualização de dados de alunos.

Esses exercícios consolidam o uso de rotas e banco de dados no Flask, e você poderá aplicá-los em projetos futuros!

---
### Resolução das Tarefas Extras

Aqui vamos implementar a resolução das tarefas extras propostas: adicionar validação de dados, excluir alunos e atualizar alunos. Vamos continuar usando **Flask**, **psycopg** e templates para realizar essas tarefas.

---

### 1. Adicionar Validação de Dados

Vamos adicionar uma validação para garantir que o nome completo e o email dos alunos não sejam duplicados no banco de dados.

#### 1.1. Modificação no Roteiro para Adicionar Aluno com Validação

No arquivo `app/routes.py`, vamos modificar a rota `adicionar_aluno` para garantir que não haja duplicatas de nome completo ou email.

```python
@app.route('/adicionar_aluno', methods=['GET', 'POST'])
def adicionar_aluno():
    if request.method == 'POST':
        nome_completo = request.form['nome_completo']
        data_nascimento = request.form['data_nascimento']
        codigo_censo = request.form['codigo_censo']
        etapa = request.form['etapa']
        id_familia = request.form['id_familia']
        
        # Converter a data de 'dd/mm/yyyy' para 'yyyy-mm-dd'
        data_nascimento_convertida = datetime.strptime(data_nascimento, '%d/%m/%Y').strftime('%Y-%m-%d')
        
        # Verificar duplicidade de nome completo
        with conectar_bd() as con:
            cur = con.cursor()
            cur.execute('SELECT * FROM escola_alunos WHERE nome_completo = %s', (nome_completo,))
            aluno_existente = cur.fetchone()
            if aluno_existente:
                return "Erro: Aluno com o nome completo já existe!"
        
        # Inserir novo aluno se não houver duplicata
        with conectar_bd() as con:
            cur = con.cursor()
            cur.execute('''
                INSERT INTO escola_alunos (codigo_censo, etapa, nome_completo, data_nascimento, id_familia)
                VALUES (%s, %s, %s, %s, %s)
            ''', (codigo_censo, etapa, nome_completo, data_nascimento_convertida, id_familia))
            con.commit()
        
        return redirect('/escolas')
    
    # Buscar escolas e famílias para preencher o formulário
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('SELECT codigo_censo, nome_escola FROM escolas')
        escolas = cur.fetchall()
        cur.execute('SELECT id_familia, nome_mae FROM familia')
        familias = cur.fetchall()
    
    return render_template('adicionar_aluno.html', escolas=escolas, familias=familias)
```

#### 1.2. Validação Implementada:
- **Verificação de duplicidade**: O nome completo é verificado no banco de dados antes da inserção para evitar duplicatas.
- **Mensagem de erro**: Se o nome completo já existir, uma mensagem de erro será retornada.

---

### 2. Excluir Alunos

Agora vamos implementar a funcionalidade para excluir alunos da lista.

#### 2.1. Criar Rota para Excluir Alunos

No arquivo `app/routes.py`, adicione a rota para excluir um aluno com base no ID.

```python
@app.route('/excluir_aluno/<int:id>', methods=['POST'])
def excluir_aluno(id):
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('DELETE FROM escola_alunos WHERE id = %s', (id,))
        con.commit()
    
    return redirect('/alunos')
```

#### 2.2. Modificar o Template para Adicionar Botão de Exclusão

No template `alunos.html`, vamos adicionar um botão para excluir cada aluno da lista.

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Alunos</title>
</head>
<body>
    <h1>Lista de Alunos</h1>
    <table border="1">
        <thead>
            <tr>
                <th>Nome Completo</th>
                <th>Data de Nascimento</th>
                <th>Escola</th>
                <th>Nome da Mãe</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for aluno in alunos %}
                <tr>
                    <td>{{ aluno[0] }}</td>
                    <td>{{ aluno[1] }}</td>
                    <td>{{ aluno[2] }}</td>
                    <td>{{ aluno[3] }}</td>
                    <td>
                        <form action="{{ url_for('excluir_aluno', id=aluno[0]) }}" method="POST" style="display:inline;">
                            <button type="submit">Excluir</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="/escolas">Voltar</a>
</body>
</html>
```

#### Explicação:
- **`<form action="{{ url_for('excluir_aluno', id=aluno[0]) }}"`**: Para cada aluno na tabela, um formulário com um botão de exclusão é criado.
- O ID do aluno é passado na URL, e a requisição `POST` é usada para executar a exclusão.

---

### 3. Atualizar Alunos

Agora vamos adicionar a funcionalidade para atualizar os dados dos alunos, como nome completo, data de nascimento, e escola.

#### 3.1. Criar Rota para Editar Alunos

No arquivo `app/routes.py`, adicione a rota para editar um aluno com base no ID.

```python
@app.route('/editar_aluno/<int:id>', methods=['GET', 'POST'])
def editar_aluno(id):
    if request.method == 'POST':
        nome_completo = request.form['nome_completo']
        data_nascimento = request.form['data_nascimento']
        codigo_censo = request.form['codigo_censo']
        etapa = request.form['etapa']
        id_familia = request.form['id_familia']

        # Converter a data de 'dd/mm/yyyy' para 'yyyy-mm-dd'
        data_nascimento_convertida = datetime.strptime(data_nascimento, '%d/%m/%Y').strftime('%Y-%m-%d')
        
        with conectar_bd() as con:
            cur = con.cursor()
            cur.execute('''
                UPDATE escola_alunos
                SET nome_completo = %s, data_nascimento = %s, codigo_censo = %s, etapa = %s, id_familia = %s
                WHERE id = %s
            ''', (nome_completo, data_nascimento_convertida, codigo_censo, etapa, id_familia, id))
            con.commit()
        
        return redirect('/alunos')
    
    # Buscar os dados do aluno para preenchimento
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('SELECT * FROM escola_alunos WHERE id = %s', (id,))
        aluno = cur.fetchone()

        # Buscar escolas e famílias para preencher o formulário
        cur.execute('SELECT codigo_censo, nome_escola FROM escolas')
        escolas = cur.fetchall()
        cur.execute('SELECT id_familia, nome_mae FROM familia')
        familias = cur.fetchall()

    return render_template('editar_aluno.html', aluno=aluno, escolas=escolas, familias=familias)
```

#### 3.2. Criar Template para Editar Aluno

No template `editar_aluno.html`, vamos criar um formulário pré-preenchido com os dados do aluno para edição.

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Aluno</title>
</head>
<body>
    <h1>Editar Aluno</h1>
    <form method="POST">
        <label for="nome_completo">Nome Completo:</label>
        <input type="text" id="nome_completo" name="nome_completo" value="{{ aluno[3] }}" required>
        <br><br>

        <label for="data_nascimento">Data de Nascimento:</label>
        <input type="text" id="data_nascimento" name="data_nascimento" value="{{ aluno[4].strftime('%d/%m/%Y') }}" required>
        <br><br>

        <label for="codigo_censo">Escola:</label>
        <select id="codigo_censo" name="codigo_censo">
            {% for escola in escolas %}
                <option value="{{ escola[0] }}" {% if escola[0] == aluno[1] %}selected{% endif %}>
                    {{ escola[1] }}
                </option>
            {% endfor %}
        </select>
        <br><br>

        <label for="etapa">Etapa:</label>
        <input type="text" id="etapa" name="etapa" value="{{ aluno[2] }}" required>
        <br><br>

        <label for="id_familia">Família:</label>
        <select id="id_familia" name="id_familia">
            {% for familia in familias %}
                <option value="{{ familia[0] }}" {% if familia[0] == aluno[6] %}selected{% endif %}>
                    {{ familia[1] }}
                </option>
            {% endfor %}
        </select>
       

 <br><br>

        <button type="submit">Salvar</button>
    </form>
    <a href="/alunos">Voltar</a>
</body>
</html>
```

#### Explicação:
- O formulário é preenchido com os dados atuais do aluno, permitindo ao usuário editar e salvar as mudanças.

---

### Conclusão

Agora você tem um sistema completo que permite adicionar, editar e excluir alunos, além de validar os dados inseridos para evitar duplicatas. Essas funcionalidades são fundamentais em qualquer aplicação que interaja com um banco de dados, e permitem gerenciar os dados de forma eficiente.

Se precisar de mais detalhes ou ajustes, estou à disposição!