### Aula 20: Exercícios Práticos de Flask (Rotas, Templates, Banco de Dados)
![](./assets/20.jpeg)
#### Introdução

Nesta aula, aplicaremos conceitos de Flask, como rotas, templates e integração com bancos de dados PostgreSQL. Utilizaremos um banco de dados já existente e faremos operações de inserção, listagem e exibição de dados diretamente com SQL. Os dados serão exibidos em **tabelas** HTML, proporcionando uma apresentação mais organizada.

#### Estrutura do Banco de Dados

O banco de dados PostgreSQL contém três tabelas principais:
- **`escolas`**
- **`familia`**
- **`escola_alunos`**

### Passo 1: Conectando-se ao Banco de Dados PostgreSQL

No Flask, podemos nos conectar ao PostgreSQL usando a biblioteca **`psycopg2`**.

##### 1.1. Instalando o `psycopg2`:

No terminal, execute o comando:

```bash
pip install psycopg2
```

##### 1.2. Configurando a Conexão no `__init__.py`:

No arquivo `app/__init__.py`, configure a conexão:

```python
from flask import Flask
import psycopg2

app = Flask(__name__)

def conectar_bd():
    return psycopg2.connect(
        host="localhost",
        database="escola_db",  # Substitua pelo nome do banco
        user="postgres",  # Substitua pelo usuário
        password="postgres"  # Substitua pela senha
    )

from app import routes
```

---

### Passo 2: Criando Rotas para Exibir e Inserir Dados

Agora vamos criar rotas para listar as escolas e os alunos, além de adicionar novos alunos.

#### 2.1. Exibindo a Lista de Escolas em uma Tabela

##### No arquivo `app/routes.py`, adicione a rota para listar as escolas:

```python
from flask import render_template
from app import app, conectar_bd

@app.route('/escolas')
def listar_escolas():
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('SELECT * FROM escolas')
        escolas = cur.fetchall()
    return render_template('escolas.html', escolas=escolas)
```

##### Crie o template `escolas.html` para exibir os dados em uma tabela:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Escolas</title>
</head>
<body>
    <h1>Lista de Escolas</h1>
    <table border="1">
        <thead>
            <tr>
                <th>Código Censo</th>
                <th>Nome da Escola</th>
                <th>Município</th>
            </tr>
        </thead>
        <tbody>
            {% for escola in escolas %}
            <tr>
                <td>{{ escola[0] }}</td>
                <td>{{ escola[1] }}</td>
                <td>{{ escola[2] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
```

#### 2.2. Adicionando um Novo Aluno

##### No arquivo `app/routes.py`, adicione a rota para adicionar alunos:

```python
@app.route('/adicionar_aluno', methods=['GET', 'POST'])
def adicionar_aluno():
    if request.method == 'POST':
        nome_completo = request.form['nome_completo']
        data_nascimento = request.form['data_nascimento']
        codigo_censo = request.form['codigo_censo']
        etapa = request.form['etapa']
        id_familia = request.form['id_familia']
        
        with conectar_bd() as con:
            cur = con.cursor()
            cur.execute('''
                INSERT INTO escola_alunos (codigo_censo, etapa, nome_completo, data_nascimento, id_familia)
                VALUES (?, ?, ?, ?, ?)
            ''', (codigo_censo, etapa, nome_completo, data_nascimento, id_familia))
            con.commit()
        
        return redirect('/escolas')
    
    # Buscar escolas e famílias para preencher o formulário
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('SELECT codigo_censo, nome_escola FROM escolas')
        escolas = cur.fetchall()
        cur.execute('SELECT id_familia, nome_mae FROM familia')
        familias = cur.fetchall()
    
    return render_template('adicionar_aluno.html', escolas=escolas, familias=familias)
```

##### Crie o template `adicionar_aluno.html` para o formulário de adição de alunos:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Aluno</title>
</head>
<body>
    <h1>Adicionar Novo Aluno</h1>
    <form method="POST">
        <label for="nome_completo">Nome Completo:</label>
        <input type="text" id="nome_completo" name="nome_completo" required>
        <br><br>
        
        <label for="data_nascimento">Data de Nascimento:</label>
        <input type="date" id="data_nascimento" name="data_nascimento" required>
        <br><br>
        
        <label for="codigo_censo">Escola:</label>
        <select id="codigo_censo" name="codigo_censo">
            {% for escola in escolas %}
                <option value="{{ escola[0] }}">{{ escola[1] }}</option>
            {% endfor %}
        </select>
        <br><br>
        
        <label for="etapa">Etapa:</label>
        <input type="text" id="etapa" name="etapa" required>
        <br><br>
        
        <label for="id_familia">Família:</label>
        <select id="id_familia" name="id_familia">
            {% for familia in familias %}
                <option value="{{ familia[0] }}">{{ familia[1] }}</option>
            {% endfor %}
        </select>
        <br><br>
        
        <button type="submit">Adicionar Aluno</button>
    </form>
    <a href="/escolas">Voltar</a>
</body>
</html>
```

#### 2.3. Exibindo Informações de Alunos em uma Tabela

##### No arquivo `app/routes.py`, adicione a rota para listar alunos:

```python
@app.route('/alunos')
def listar_alunos():
    with conectar_bd() as con:
        cur = con.cursor()
        cur.execute('''
            SELECT escola_alunos.nome_completo, escola_alunos.data_nascimento, escolas.nome_escola, familia.nome_mae
            FROM escola_alunos
            JOIN escolas ON escola_alunos.codigo_censo = escolas.codigo_censo
            JOIN familia ON escola_alunos.id_familia = familia.id_familia
        ''')
        alunos = cur.fetchall()
    
    return render_template('alunos.html', alunos=alunos)
```

##### Crie o template `alunos.html` para exibir os alunos em uma tabela:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Alunos</title>
</head>
<body>
    <h1>Lista de Alunos</h1>
    <table border="1">
        <thead>
            <tr>
                <th>Nome Completo</th>
                <th>Data de Nascimento</th>
                <th>Escola</th>
                <th>Mãe</th>
            </tr>
        </thead>
        <tbody>
            {% for aluno in alunos %}
            <tr>
                <td>{{ aluno[0] }}</td>
                <td>{{ aluno[1] }}</td>
                <td>{{ aluno[2] }}</td>
                <td>{{ aluno[3] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="/escolas">Voltar</a>
</body>
</html>
```

---

### Conclusão

Você aprendeu como se conectar a um banco de dados PostgreSQL, listar dados em tabelas, adicionar novos alunos, e exibir informações detalhadas sobre alunos e escolas em tabelas HTML.

### Tarefas Extras:
1. **Excluir Alunos**: Adicione uma funcionalidade para excluir alunos diretamente da lista.
2. **Atualizar Dados dos Alunos**: Adicione uma funcionalidade para atualizar as informações de um aluno.
3. **Filtrar Alunos por Escola**: Crie uma funcionalidade para filtrar os alunos por escola.